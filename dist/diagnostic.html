<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGP Simulator - Diagnostic</title>
    <style>
        body {
            font-family: monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            margin: 0;
        }
        .log-container {
            background: #252526;
            border: 1px solid #3e3e42;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 600px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.5;
        }
        .log-entry {
            margin: 5px 0;
            padding: 2px 5px;
        }
        .log-info { color: #4ec9b0; }
        .log-warn { color: #ce9178; }
        .log-error { color: #f48771; }
        .log-success { color: #6a9955; }
        h1 { color: #4ec9b0; }
        h2 { color: #9cdcfe; font-size: 14px; margin-top: 20px; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
            font-family: monospace;
        }
        button:hover {
            background: #1177bb;
        }
        .status { margin: 10px 0; padding: 10px; background: #333; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>BGP Simulator - Diagnostic Tool</h1>

    <div class="status">
        <strong>Module Status:</strong> <span id="module-status">Checking...</span>
    </div>

    <div class="status">
        <strong>BGPSimulator Class:</strong> <span id="simulator-status">Checking...</span>
    </div>

    <div class="status">
        <strong>Simulator Instance:</strong> <span id="instance-status">Checking...</span>
    </div>

    <h2>Actions</h2>
    <button onclick="testModuleLoad()">Test Module Load</button>
    <button onclick="testSimulatorClass()">Test BGPSimulator Class</button>
    <button onclick="testSimulatorInstance()">Test Instance Creation</button>
    <button onclick="clearLog()">Clear Log</button>

    <h2>Console Output</h2>
    <div class="log-container" id="log-output"></div>

    <script>
        // Custom logging
        const logOutput = document.getElementById('log-output');
        const logs = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logClass = `log-${type}`;
            const entry = `[${timestamp}] ${message}`;
            logs.push(entry);

            const logDiv = document.createElement('div');
            logDiv.className = `log-entry ${logClass}`;
            logDiv.textContent = entry;
            logOutput.appendChild(logDiv);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLog() {
            logOutput.innerHTML = '';
            logs = [];
        }

        // Intercept console methods
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog(...args);
            addLog(args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalError(...args);
            addLog(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn(...args);
            addLog(args.join(' '), 'warn');
        };

        // Setup Module before scripts load
        window.Module = window.Module || {};
        addLog('window.Module created');

        const originalOnRuntimeInitialized = window.Module.onRuntimeInitialized;
        window.Module.onRuntimeInitialized = function() {
            addLog('Module.onRuntimeInitialized fired!', 'success');
            if (originalOnRuntimeInitialized) {
                originalOnRuntimeInitialized();
            }
            updateStatus();
        };

        function updateStatus() {
            const moduleStatus = document.getElementById('module-status');
            const simulatorStatus = document.getElementById('simulator-status');
            const instanceStatus = document.getElementById('instance-status');

            if (typeof Module !== 'undefined') {
                moduleStatus.textContent = '✓ Loaded';
                moduleStatus.style.color = '#6a9955';
            } else {
                moduleStatus.textContent = '✗ Not loaded';
                moduleStatus.style.color = '#f48771';
            }

            if (typeof Module !== 'undefined' && typeof Module.BGPSimulator !== 'undefined') {
                simulatorStatus.textContent = '✓ Available';
                simulatorStatus.style.color = '#6a9955';
            } else {
                simulatorStatus.textContent = '✗ Not available';
                simulatorStatus.style.color = '#f48771';
            }

            if (window.simulator) {
                instanceStatus.textContent = '✓ Created';
                instanceStatus.style.color = '#6a9955';
            } else {
                instanceStatus.textContent = '✗ Not created';
                instanceStatus.style.color = '#f48771';
            }
        }

        function testModuleLoad() {
            addLog('Testing Module...', 'info');
            if (typeof Module !== 'undefined') {
                addLog('✓ Module is defined', 'success');
                addLog('Module keys: ' + Object.keys(Module).slice(0, 10).join(', ') + '...', 'info');
            } else {
                addLog('✗ Module is not defined', 'error');
            }
            updateStatus();
        }

        function testSimulatorClass() {
            addLog('Testing BGPSimulator class...', 'info');
            if (typeof Module === 'undefined') {
                addLog('✗ Module not defined yet', 'error');
                return;
            }
            if (typeof Module.BGPSimulator !== 'undefined') {
                addLog('✓ BGPSimulator class is available', 'success');
            } else {
                addLog('✗ BGPSimulator class not found', 'error');
                addLog('Available bindings: ' + Object.keys(Module).filter(k => !k.startsWith('_')).join(', '), 'warn');
            }
            updateStatus();
        }

        function testSimulatorInstance() {
            addLog('Creating simulator instance...', 'info');
            if (typeof Module === 'undefined') {
                addLog('✗ Module not defined', 'error');
                return;
            }
            if (typeof Module.BGPSimulator === 'undefined') {
                addLog('✗ BGPSimulator class not available', 'error');
                return;
            }
            try {
                window.simulator = new Module.BGPSimulator();
                addLog('✓ Simulator instance created successfully!', 'success');
            } catch (error) {
                addLog('✗ Failed to create instance: ' + error.message, 'error');
            }
            updateStatus();
        }

        addLog('Diagnostic page loaded', 'info');
        addLog('Waiting for WASM module...', 'warn');
        updateStatus();

        // Check status every 2 seconds
        setInterval(updateStatus, 2000);
    </script>

    <!-- Load WASM module -->
    <script src="bgp_simulator_wasm.js"></script>
    <script src="preset-data.js"></script>
</body>
</html>
